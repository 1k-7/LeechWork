name: Big Leech Runner

on:
  repository_dispatch:
    types: [big_leech]

jobs:
  upload-big-file:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Tools
        run: |
          pip install pyrogram tgcrypto yt-dlp requests
          sudo apt-get install -y ffmpeg

      - name: Run Leech
        env:
          SESSION_STRING: ${{ secrets.SESSION_STRING }}
          BOT_TOKEN: "YOUR_BOT_TOKEN_HERE" # OPTIONAL: Hardcode ONLY if secrets fail
          CHAT_ID: ${{ github.event.client_payload.chat_id }}
          LINK: ${{ github.event.client_payload.url }}
        run: |
          python3 <<EOF
          import os
          import time
          import asyncio
          import glob
          import traceback
          import requests
          from pyrogram import Client
          import yt_dlp

          # SETUP VARS
          CHAT_ID = int(os.environ['CHAT_ID'])
          URL = os.environ['LINK']
          # NOTE: Add your BOT_TOKEN below just for error reporting fallback
          BOT_TOKEN = "${{ secrets.BOT_TOKEN }}" # Make sure this secret exists too!

          def send_fallback_error(text):
              """Sends error via HTTP if Pyrogram crashes"""
              if BOT_TOKEN:
                  requests.post(
                      f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
                      json={"chat_id": CHAT_ID, "text": text}
                  )
              print(text)

          # GLOBAL VARS FOR PROGRESS
          last_edit_time = 0
          status_msg = None

          async def progress(current, total):
              global last_edit_time, status_msg
              try:
                  now = time.time()
                  if status_msg and (now - last_edit_time > 5):
                      percent = current * 100 / total
                      await status_msg.edit_text(f"‚¨ÜÔ∏è **Uploading:** {percent:.1f}%")
                      last_edit_time = now
              except Exception:
                  pass 

          async def main():
              global status_msg
              
              if not os.environ.get('SESSION_STRING'):
                  send_fallback_error("‚ùå CRITICAL: SESSION_STRING secret is missing!")
                  return

              try:
                  # LOGIN
                  app = Client(
                      "leech_session", 
                      session_string=os.environ['SESSION_STRING'], 
                      api_id=2040, 
                      api_hash="b18441a1ff607e10a989891a5462e627"
                  )
                  await app.start()
                  
                  # Notify User
                  status_msg = await app.send_message(CHAT_ID, f"üöÄ **GitHub Runner Active**\n‚öôÔ∏è Processing: `{URL}`")
                  
                  # DOWNLOAD
                  await status_msg.edit_text(f"‚¨áÔ∏è **Downloading...**\n(Please wait, this happens on server)")
                  
                  ydl_opts = {
                      'outtmpl': '%(title)s.%(ext)s',
                      'quiet': True,
                      'format': 'bestvideo+bestaudio/best',
                      'merge_output_format': 'mp4'
                  }
                  
                  filename = None
                  with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                      info = ydl.extract_info(URL, download=True)
                      filename = ydl.prepare_filename(info)
                      if not os.path.exists(filename):
                          base = os.path.splitext(filename)[0]
                          files = glob.glob(base + "*")
                          if files: filename = files[0]

                  if not filename:
                      raise Exception("Download failed, no file found.")

                  # UPLOAD
                  file_size = os.path.getsize(filename) / (1024 * 1024)
                  await status_msg.edit_text(f"‚¨ÜÔ∏è **Starting Upload:** `{filename}`\nüì¶ Size: {file_size:.2f} MB")
                  
                  await app.send_document(
                      CHAT_ID, 
                      document=filename, 
                      caption=f"üì¶ **{filename}**",
                      progress=progress
                  )
                  
                  await status_msg.delete()
                  await app.send_message(CHAT_ID, "‚úÖ **Done!**")
                  
                  if os.path.exists(filename): os.remove(filename)

              except Exception as e:
                  err_msg = f"‚ùå **Script Error:** {str(e)}"
                  send_fallback_error(err_msg)
                  traceback.print_exc()
              finally:
                  if 'app' in locals() and app.is_connected:
                      await app.stop()

          if __name__ == "__main__":
              asyncio.run(main())
          EOF
